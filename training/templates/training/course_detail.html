{% extends 'base.html' %}
{% load quiz_filters %}
{% load static %}

{% block title %}
{{ course.title }} - Course Details
{% endblock %}

{% block content %}
<style>
    /* –°—Ç–∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .course-container {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 40px;
        text-align: left;
    }

    .course-title {
        color: #1a237e;
        font-size: 2.5em;
        margin-bottom: 20px;
        border-bottom: 3px solid #3f51b5;
        padding-bottom: 15px;
        font-weight: 500;
        text-align: center;
    }

    .lecture-card {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .lecture-header {
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(145deg, #f8f9fa, #f1f3f5);
        transition: background 0.3s ease;
    }

    .lecture-header:hover {
        background: linear-gradient(145deg, #f1f3f5, #e9ecef);
    }

    .lecture-content {
        max-height: 0; /* –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –∑–∞–∫—Ä—ã—Ç–æ */
        overflow: hidden;
        padding: 0 20px; /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π padding */
        transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .lecture-content.active {
        max-height: 1000px; /* –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è */
        padding: 20px; /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º padding –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
    }

    .toggle-icon {
        transition: transform 0.3s ease;
    }

    .toggle-icon.open {
        transform: rotate(180deg); /* –ü–æ–≤–æ—Ä–æ—Ç —Å—Ç—Ä–µ–ª–∫–∏ –≤–Ω–∏–∑ */
    }

    .file-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .file-download-btn {
        display: flex;
        align-items: center;
        padding: 10px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        text-decoration: none;
        color: #2c3e50;
        transition: all 0.3s ease;
        flex-grow: 1;
    }

    .file-download-btn:hover {
        background: #f5f7fa;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .file-name {
        margin-left: 10px;
        flex-grow: 1;
    }

    .file-delete-btn {
        margin-left: 10px;
        background: linear-gradient(145deg, #f44336, #e53935);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .file-delete-btn:hover {
        background: linear-gradient(145deg, #e53935, #d32f2f);
    }

    .admin-control {
        display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .edit-mode .admin-control {
        display: block;
        opacity: 1;
    }

    .quiz-card {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 25px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .quiz-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    .toggle-icon {
        transition: transform 0.3s ease;
    }
    .admin-control {
        display: none;
        opacity: 0;
        position: absolute; /* Add this */
        visibility: hidden; /* Add this */
        transition: opacity 0.3s ease;
    }

    .edit-mode .admin-control {
        display: inline-block;
        opacity: 1;
        position: static; /* Add this */
        visibility: visible; /* Add this */
    }
    .file-upload-section {
    margin-top: 20px;
    padding: 15px;
    background: rgba(63, 81, 181, 0.05);
    border-radius: 8px;
    }

    .file-upload-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .file-input {
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        flex-grow: 1;
    }

    .file-name-input {
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        min-width: 200px;
    }

    .upload-btn {
        background: linear-gradient(145deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
    }

    .upload-btn:hover {
        background: linear-gradient(145deg, #45a049, #3d8b40);
    }
    .main-container {
        width: 80%;
        margin: 0 auto;
        max-width: 1200px;
    }
    .add-lecture-btn {
        background: linear-gradient(145deg, #3f51b5, #3949ab);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        margin: 20px 0;
        display: inline-block;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .add-lecture-btn:hover {
        background: linear-gradient(145deg, #3949ab, #303f9f);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        color: white;
    }
    .btn-compact {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        margin: 5px;
        font-size: 0.9em;
        border-radius: 6px;
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        color: #495057;
        text-decoration: none;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .btn-compact:hover {
        background: linear-gradient(145deg, #e9ecef, #dee2e6);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        color: #212529;
    }

    .btn-compact i {
        margin-right: 6px;
    }
    .add-quiz-btn {
        background: linear-gradient(145deg, #3f51b5, #3949ab);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        margin: 20px 0;
        display: inline-block;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .add-quiz-btn:hover {
        background: linear-gradient(145deg, #3949ab, #303f9f);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        color: white;
    }
    .quiz-description {
        margin: 10px 0;
        color: #666;
    }

    .quiz-stats {
        margin: 15px 0;
        padding: 10px;
        background: rgba(63, 81, 181, 0.05);
        border-radius: 8px;
    }

    .quiz-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    </style>
{% csrf_token %}
<div class="main-container">
<div class="course-container">
    {% if profile.role == 'admin' or course.instructor == user %}
    <div class="edit-toggle-container" style="text-align: right; margin-bottom: 20px;">
        <label class="switch">
            <input type="checkbox" id="editModeToggle" aria-label="–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
            <span class="slider round"></span>
            <span class="toggle-label">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
        </label>
    </div>
    {% endif %}

    <h1 class="course-title">{{ course.title }}</h1>
    <p>{{ course.description }}</p>

    {% if profile.role == 'admin' or course.instructor == user %}
    <a href="{% url 'edit_course' course.id %}" class="btn btn-compact admin-control">
        <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å –∫—É—Ä—Å
    </a>
    {% endif %}
</div>

<div class="lectures-section">
    <h2 style="text-align:center;">–õ–µ–∫—Ü–∏–∏ –∫—É—Ä—Å–∞</h2>
    <a href="{% url 'create_lecture' course.id %}" class="btn add-lecture-btn admin-control" aria-label="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ª–µ–∫—Ü–∏—é">
        –î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫—Ü–∏—é
    </a>
    {% for lecture in course.lectures.all %}
    <div class="lecture-card">
        <div class="lecture-header" onclick="toggleLecture({{ lecture.id }})" role="button" aria-expanded="false">
            <h3 class="lecture-title">{{ lecture.title }}</h3>
            <span class="toggle-icon" id="icon-{{ lecture.id }}">‚ñº</span>
        </div>
        <div class="lecture-content" id="lecture-{{ lecture.id }}">
            {{ lecture.content|safe }}

            <h4>–§–∞–π–ª—ã</h4>
            {% if profile.role == 'admin' or profile.role == 'instructor' %}
                        <div class="file-upload-section admin-control">
                            <form class="file-upload-form admin-control" method="post" enctype="multipart/form-data" data-lecture-id="{{ lecture.id }}">
                                {% csrf_token %}
                                <input type="file" name="file" class="file-input admin-control" required aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏">
                                <input type="text" name="file_name" class="file-name-input admin-control" placeholder="–ò–º—è —Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                                <button type="submit" class="btn upload-btn admin-control">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                            </form>
                        </div>
            {% endif %}
            {% if lecture.files.all %}
            <div class="lecture-files">
                {% for file in lecture.files.all %}
                <div class="file-item" data-file-id="{{ file.id }}">
                    <a href="{{ file.file.url }}" class="file-download-btn" target="_blank" aria-label="–°–∫–∞—á–∞—Ç—å {{ file.name }}">
                        <span class="file-icon">üìÑ</span>
                        <span class="file-name">{{ file.name }}</span>
                    </a>
                    {% if profile.role == 'admin' or profile.role == 'instructor' %}
                    <button onclick="deleteFile({{ file.id }})" class="btn file-delete-btn admin-control">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –ª–µ–∫—Ü–∏–∏.</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="quiz-section">
    <h2 style="text-align:center;">–¢–µ—Å—Ç—ã –∫—É—Ä—Å–∞</h2>
    <a href="{% url 'add_quiz' course.id %}" class="btn add-quiz-btn admin-control" aria-label="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç">
        –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
    </a>
    {% for quiz in course.quizzes.all %}
    <div class="quiz-card" id="quiz-{{ quiz.id }}">
        <h3 class="quiz-title">{{ quiz.title }}</h3>
        <div class="quiz-stats">
            <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {{ quiz.questions.count }}</p>
            <p>–í—Ä–µ–º—è –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ: {{ quiz.time_limit }} –º–∏–Ω—É—Ç</p>
        </div>
    
        <!-- Quiz Actions -->
        <div class="quiz-actions">
            <a href="{% url 'take_quiz' quiz.id %}" class="btn btn-compact">
                <i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
            </a>
            
            {% if profile.role == 'instructor' and course.instructor == user or profile.role == 'admin' %}
            <a href="{% url 'edit_quiz' quiz.id %}" class="btn btn-compact admin-control">
                <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <button onclick="deleteQuiz({{ quiz.id }})" class="btn btn-compact delete-btn admin-control">
                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
            </button>
            {% endif %}
        </div>
        {% if profile.role == 'instructor' and course.instructor == user or profile.role == 'admin' %}
        <a href="{% url 'edit_quiz' quiz.id %}" class="btn btn-compact admin-control">
            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </a>
        <button onclick="deleteQuiz({{ quiz.id }})" class="btn btn-compact delete-btn admin-control">
            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
        </button>
        {% endif %}
    </div>
    {% endfor %}
</div>
</div>

<script>
    // –õ–æ–≥–∏–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        const editModeToggle = document.getElementById('editModeToggle');
        const body = document.body;

        editModeToggle?.addEventListener('change', function () {
            if (this.checked) {
                body.classList.add('edit-mode');
            } else {
                body.classList.remove('edit-mode');
            }
        });
    });


    document.getElementById('editModeToggle')?.addEventListener('change', function() {
        setTimeout(() => {
            document.querySelectorAll('.lecture-content.active').forEach(content => {
                content.style.maxHeight = content.scrollHeight + "px";
            });
        }, 50);
    });

    function toggleLecture(lectureId) {
        const content = document.getElementById(`lecture-${lectureId}`);
        const icon = document.getElementById(`icon-${lectureId}`);

        if (content.classList.contains('active')) {
            content.classList.remove('active');
            content.style.maxHeight = null;
            icon.classList.remove('open');
        } else {
            content.classList.add('active');
            setTimeout(() => {
                const totalHeight = content.scrollHeight;
                content.style.maxHeight = totalHeight + "px";
            }, 50);
            icon.classList.add('open');
        }
    }


    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ª–µ–∫—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.lecture-content').forEach(content => {
            content.style.maxHeight = null;
        });
    });

    // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
    function deleteQuiz(quizId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç?')) {
            fetch(`/delete_quiz/${quizId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    const quizCard = document.getElementById(`quiz-${quizId}`);
                    quizCard.remove();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞.');
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞:', error));
        }
    }

    document.querySelectorAll('.file-upload-form').forEach(form => {
    form.addEventListener('submit', function (e) {
        e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        

        const lectureId = this.getAttribute('data-lecture-id'); // ID –ª–µ–∫—Ü–∏–∏
        const formData = new FormData(this); // –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã

        fetch(`/upload_lecture_file/${lectureId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
        });
    });
});
    // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    function deleteFile(fileId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) {
        fetch(`/delete_lecture_file/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ file_id: fileId }),
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–∞–π–ª.');
            }
        })
        .then(data => {
            if (data.status === 'success') {
                const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileElement) {
                    fileElement.remove();
                }
                alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.');
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        });
    }
}

</script>
{% endblock %}